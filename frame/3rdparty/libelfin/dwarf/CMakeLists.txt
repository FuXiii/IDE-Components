project(dwarf++)

set(CMAKE_VERBOSE_MAKEFILE ON)

add_definitions(-g -O2 -Werror --std=c++0x -Wall -fPIC)

execute_process(
    COMMAND date
    OUTPUT_VARIABLE DATA_OUT_VAL
)

message(STATUS ${DATA_OUT_VAL})

execute_process(
    COMMAND python3 ../elf/enum-print.py
    INPUT_FILE dwarf++.hh
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    OUTPUT_VARIABLE DWARF_H_OUT_VAL
)

execute_process(
    COMMAND python3 ../elf/enum-print.py -s _ -u --hex -x hi_user -x lo_user
    INPUT_FILE data.hh
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    OUTPUT_VARIABLE DATA_H_OUT_VAL
)

file(REMOVE to_string.cc)
file(TOUCH to_string.cc)
file(APPEND to_string.cc "// Automatically generated by make at ${DATA_OUT_VAL}")
file(APPEND to_string.cc "// DO NOT EDIT\n")
file(APPEND to_string.cc "#include \"internal.hh\"\n\n")
file(APPEND to_string.cc "DWARFPP_BEGIN_NAMESPACE\n\n")
foreach(VAR ${DWARF_H_OUT_VAL})
    file(APPEND to_string.cc "${VAR};")
endforeach()
foreach(VAR ${DATA_H_OUT_VAL})
    file(APPEND to_string.cc "${VAR};")
endforeach()
file(APPEND to_string.cc "DWARFPP_END_NAMESPACE\n")


set(SRCS dwarf.cc cursor.cc die.cc value.cc abbrev.cc
    expr.cc rangelist.cc line.cc attrs.cc
    die_str_map.cc elf.cc to_string.cc)

set(HDRS dwarf++.hh data.hh internal.hh
    small_vector.hh ../elf/to_hex.hh)

aux_source_directory(${CMAKE_CURRENT_SOURCE_DIR} dwarf_SRC)
add_library(
    ${PROJECT_NAME}
    SHARED
    ${SRCS}
    ${HDRS}
    )
